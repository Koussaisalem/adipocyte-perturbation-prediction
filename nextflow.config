// Nextflow configuration for adipocyte perturbation prediction pipeline

// ========================================
// Profiles
// ========================================

profiles {
    standard {
        process.executor = 'local'
        process.cpus = 4
        process.memory = '16 GB'
    }
    
    camber {
        process.executor = 'local'
        
        process {
            withLabel: cpu {
                cpus = 2
                memory = '8 GB'
            }
            
            withLabel: gpu {
                cpus = 4
                memory = '16 GB'
                clusterOptions = '--gpu'
            }
            
            withLabel: gpu_large {
                cpus = 8
                memory = '32 GB'
                clusterOptions = '--gpu --size medium'
            }
        }
    }
    
    local_gpu {
        process.executor = 'local'
        
        process {
            withLabel: cpu {
                cpus = 4
                memory = '16 GB'
            }
            
            withLabel: gpu {
                cpus = 8
                memory = '32 GB'
                containerOptions = '--gpus all'
            }
            
            withLabel: gpu_large {
                cpus = 16
                memory = '64 GB'
                containerOptions = '--gpus all'
            }
        }
    }
    
    hpc {
        process.executor = 'slurm'
        process.queue = 'gpu'
        
        process {
            withLabel: cpu {
                cpus = 4
                memory = '16 GB'
                time = '2h'
            }
            
            withLabel: gpu {
                cpus = 8
                memory = '32 GB'
                time = '8h'
                clusterOptions = '--gres=gpu:1'
            }
            
            withLabel: gpu_large {
                cpus = 16
                memory = '64 GB'
                time = '24h'
                clusterOptions = '--gres=gpu:1 --partition=gpu-l4'
            }
        }
    }
}

// ========================================
// Execution settings
// ========================================

executor {
    queueSize = 10
    pollInterval = '30 sec'
}

// ========================================
// Reporting
// ========================================

report {
    enabled = true
    file = "${params.experiments_dir}/reports/nextflow_report.html"
}

timeline {
    enabled = true
    file = "${params.experiments_dir}/reports/nextflow_timeline.html"
}

trace {
    enabled = true
    file = "${params.experiments_dir}/reports/nextflow_trace.txt"
}

dag {
    enabled = true
    file = "${params.experiments_dir}/reports/nextflow_dag.svg"
}

// ========================================
// Container settings (optional)
// ========================================

// Uncomment to use Docker/Singularity
// docker {
//     enabled = true
//     runOptions = '-u $(id -u):$(id -g)'
// }

// singularity {
//     enabled = true
//     autoMounts = true
// }

// ========================================
// Resource limits
// ========================================

process {
    errorStrategy = 'retry'
    maxRetries = 2
    
    // Time limits
    time = '12h'
    
    // Memory limits with retry strategy
    memory = { 16.GB * task.attempt }
    
    // CPU limits
    cpus = { 4 * task.attempt }
}

// ========================================
// Manifest
// ========================================

manifest {
    name = 'adipocyte-perturbation-prediction'
    author = 'Koussai Salem'
    homePage = 'https://github.com/Koussaisalem/adipocyte-perturbation-prediction'
    description = 'Nextflow pipeline for adipocyte perturbation prediction using Geneformer and GAT'
    mainScript = 'main.nf'
    nextflowVersion = '>=22.04.0'
    version = '1.0.0'
}
